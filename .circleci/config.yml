version: 2.1

orbs:
  dop: dbmaestro/devops-automation@1.0.0

executors:
  default:
    docker:
      - image: 'cimg/openjdk:16.0.2'

jobs:
  create-package:
    executor: default
    environment:
      DBMAESTRO_AUTH_TYPE: DBmaestroAccount
      DBMAESTRO_SERVER_ADDRESS: '35.239.85.41:7017'
      DBMAESTRO_USERNAME: test@dbmaestro.com
    steps:
      - checkout
      - dop/download-automation-jar
      - run:
          name: Get package scripts
          command: | 
            files=`git diff --name-only --diff-filter=AM HEAD~1..HEAD -- Scripts\*.sql`
            echo $files
            rm -rf packages || true
            mkdir -p packages/crs
            cp "${files[@]}" packages/crs
      - dop/create-manifest-file:
          path_to_scripts_folder: packages
      - run:
          name: Prepare package zip
          command: cd packages&&zip -r ../V$CIRCLE_BUILD_NUM.zip *&&cd ..
      - dop/package:
          file_path: V$CIRCLE_BUILD_NUM.zip
          project_name: CircleCI Project

  pre-check-package:
    executor: default
    environment:
      DBMAESTRO_AUTH_TYPE: DBmaestroAccount
      DBMAESTRO_SERVER_ADDRESS: '35.239.85.41:7017'
      DBMAESTRO_USERNAME: test@dbmaestro.com
    steps:
      - dop/download-automation-jar
      - dop/pre-check:
          package_name: "@latest"
          project_name: CircleCI Project

  upgrade-rs:
    executor: default
    environment:
      DBMAESTRO_AUTH_TYPE: DBmaestroAccount
      DBMAESTRO_SERVER_ADDRESS: '35.239.85.41:7017'
      DBMAESTRO_USERNAME: test@dbmaestro.com
    steps:
      - dop/download-automation-jar
      - dop/upgrade:
          environment_name: Release Source
          package_name: "@latest"
          project_name: CircleCI Project

  validate-prod:
    executor: default
    environment:
      DBMAESTRO_AUTH_TYPE: DBmaestroAccount
      DBMAESTRO_SERVER_ADDRESS: '35.239.85.41:7017'
      DBMAESTRO_USERNAME: test@dbmaestro.com
    steps:
      - dop/download-automation-jar
      - dop/validate:
          environment_name: Prod_Env_1
          package_name: "@current"
          project_name: CircleCI Project

workflows:
  test-run:
    jobs:
      - create-package
      - pre-check-package:
          requires:
            - create-package
      - upgrade-rs:
          requires:
            - pre-check-package
      - validate-prod:
          requires:
            - upgrade-rs
